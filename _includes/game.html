<section id="fun-zone" class="content-section" style="text-align: center; margin-top: 80px; padding-bottom: 40px;">
  <h2 class="section-title" style="font-size: 1.5rem; color: #555; margin-bottom: 10px;">
    ğŸ¤– å­¦æœ¯ç”Ÿå­˜æŒ‘æˆ˜
  </h2>
  <p style="font-size: 0.9rem; color: #888; margin-bottom: 15px;">
    (æŒ‰ <kbd style="background:#eee; padding:2px 5px; border-radius:3px;">ç©ºæ ¼</kbd> æˆ–ç‚¹å‡»å±å¹•è·³è·ƒï¼Œèº²é¿ DDLï¼)
  </p>
  
  <canvas id="dinoGame" width="600" height="160" style="border-bottom: 2px solid #555; background: #fafafa; max-width: 100%; touch-action: none; border-radius: 4px;"></canvas>
  
  <div style="display: flex; justify-content: space-between; max-width: 600px; margin: 10px auto; font-family: monospace; font-size: 1rem; color: #333;">
    <span>å½“å‰å¾—åˆ†: <b id="score" style="color: #007bff;">0</b></span>
    <span>æœ€é«˜è®°å½•: <b id="highScore" style="color: #c0392b;">0</b></span>
  </div>
  
  <button id="restartBtn" class="button-primary" style="display: none; margin-top: 15px; cursor: pointer;" onclick="initGame()">
    å†æ¥ä¸€æ¬¡ (Restart)
  </button>
</section>

<script>
const canvas = document.getElementById('dinoGame');
const ctx = canvas.getContext('2d');
const scoreEl = document.getElementById('score');
const highScoreEl = document.getElementById('highScore');
const restartBtn = document.getElementById('restartBtn');

// æ¸¸æˆé…ç½®
let gameSpeed = 4;
let score = 0;
let highScore = localStorage.getItem('dinoHighScore') || 0;
let isGameOver = false;
let animationId;
let frame = 0;

// ç©å®¶å¯¹è±¡
let player = {
    x: 50,
    y: 110,     // åˆå§‹åœ°é¢ä½ç½®
    w: 30,      // ç¢°æ’ç®±å®½åº¦
    h: 30,      // ç¢°æ’ç®±é«˜åº¦
    dy: 0,      // å‚ç›´é€Ÿåº¦
    jumpPower: -11, // è·³è·ƒåŠ›åº¦
    gravity: 0.6,   // é‡åŠ›
    grounded: false // æ˜¯å¦åœ¨åœ°é¢
};

let obstacles = [];

// åˆå§‹åŒ–/é‡ç½®æ¸¸æˆ
function initGame() {
    isGameOver = false;
    score = 0;
    gameSpeed = 5; // åˆå§‹é€Ÿåº¦
    obstacles = [];
    frame = 0;
    player.y = 110;
    player.dy = 0;
    
    restartBtn.style.display = 'none';
    scoreEl.innerText = score;
    highScoreEl.innerText = highScore;
    
    animate();
}

// --- ğŸ¨ æ ¸å¿ƒç»˜åˆ¶å‡½æ•° ---

// 1. ç»˜åˆ¶ç©å®¶ (æé¾™/è€é¹°)
function drawPlayer() {
    ctx.textAlign = "left";
    ctx.textBaseline = "top";
    
    if (player.grounded) {
        // åœ¨åœ°é¢ï¼šæ˜¾ç¤ºæé¾™
        ctx.font = "35px Arial"; // ç¨å¾®æ¯”ç¢°æ’ç®±å¤§ä¸€ç‚¹ï¼Œè§†è§‰æ•ˆæœæ›´å¥½
        ctx.fillText("ğŸ¤–", player.x - 2, player.y - 5); 
    } else {
        // åœ¨ç©ºä¸­ï¼šæ˜¾ç¤ºè€é¹°
        ctx.font = "38px Arial"; 
        ctx.fillText("ğŸ‘»", player.x - 5, player.y - 8);
    }
    
    // è°ƒè¯•æ¨¡å¼ï¼šå–æ¶ˆä¸‹é¢æ³¨é‡Šå¯ä»¥çœ‹åˆ°å®é™…çš„ç¢°æ’ç®±ï¼ˆçº¢è‰²æ¡†ï¼‰
    // ctx.strokeStyle = "red"; ctx.strokeRect(player.x, player.y, player.w, player.h);
}

// 2. ç»˜åˆ¶éšœç¢ç‰© (DDL)
function drawObstacles() {
    obstacles.forEach(obs => {
        ctx.fillStyle = '#c0392b'; // æ·±çº¢è‰²ï¼Œä»£è¡¨å±é™©
        ctx.font = "bold 20px Verdana";
        ctx.textAlign = "left";
        ctx.textBaseline = "top";
        
        ctx.fillText("DDL", obs.x, obs.y + 2); // ç»˜åˆ¶æ–‡å­—
        
        // è£…é¥°ï¼šåŠ ä¸€æ¡ä¸‹åˆ’çº¿è®©å®ƒçœ‹èµ·æ¥æ›´åƒæ–‡ä»¶
        ctx.fillRect(obs.x, obs.y + 22, obs.w, 3);
        
        // è°ƒè¯•æ¨¡å¼ï¼šç¢°æ’ç®±
        // ctx.strokeStyle = "blue"; ctx.strokeRect(obs.x, obs.y, obs.w, obs.h);
    });
}

// --- âš™ï¸ ç‰©ç†é€»è¾‘ ---

function update() {
    // 1. ç©å®¶ç‰©ç†
    player.dy += player.gravity;
    player.y += player.dy;

    // åœ°é¢æ£€æµ‹ (110 æ˜¯åœ°é¢ Y åæ ‡)
    if (player.y > 110) {
        player.y = 110;
        player.dy = 0;
        player.grounded = true;
    } else {
        player.grounded = false;
    }

    // 2. ç”Ÿæˆéšœç¢ç‰©
    frame++;
    // éšæœºç”Ÿæˆé—´éš”ï¼Œéšç€åˆ†æ•°æé«˜ï¼Œé—´éš”ç¨å¾®å˜çŸ­
    let spawnRate = Math.floor(90 + Math.random() * 60);
    if (frame % spawnRate === 0) {
        // éšæœºé«˜åº¦çš„ DDL (æœ‰äº›éœ€è¦å°è·³ï¼Œæœ‰äº›éœ€è¦å¤§è·³)
        // åœ°é¢æ˜¯ 110ï¼Œéšœç¢ç‰©é«˜åº¦éšæœºæµ®åŠ¨
        let isHigh = Math.random() > 0.8; // 20% å‡ ç‡ç”Ÿæˆé«˜ç©º DDL
        let obsY = isHigh ? 80 : 110; 
        
        obstacles.push({
            x: canvas.width,
            y: obsY,
            w: 45, // "DDL" æ–‡å­—çš„å¤§è‡´å®½åº¦
            h: 25  // "DDL" æ–‡å­—çš„å¤§è‡´é«˜åº¦
        });
    }

    // 3. ç§»åŠ¨éšœç¢ç‰© & ç¢°æ’
    for (let i = 0; i < obstacles.length; i++) {
        let obs = obstacles[i];
        obs.x -= gameSpeed;

        // ç§»é™¤å±å¹•å¤–çš„
        if (obs.x + obs.w < 0) {
            obstacles.splice(i, 1);
            score++;
            scoreEl.innerText = score;
            i--;
            
            // ğŸ”¥ éš¾åº¦é€’å¢ï¼šæ¯å¾— 5 åˆ†ï¼Œé€Ÿåº¦åŠ å¿«
            if (score % 5 === 0) gameSpeed += 0.4; 
        }

        // ğŸ’¥ ç¢°æ’æ£€æµ‹ (AABB ç®—æ³•)
        // ç¨å¾®ç¼©å°ä¸€ç‚¹ç©å®¶çš„åˆ¤å®šèŒƒå›´ (padding)ï¼Œè®©æ¸¸æˆä¸è¦å¤ªéš¾
        let padding = 4; 
        if (
            player.x + padding < obs.x + obs.w &&
            player.x + player.w - padding > obs.x &&
            player.y + padding < obs.y + obs.h &&
            player.y + player.h - padding > obs.y
        ) {
            gameOver();
        }
    }
}

function draw() {
    // æ¸…ç©ºç”»å¸ƒ
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // ç”»åœ°é¢çº¿
    ctx.beginPath();
    ctx.moveTo(0, 140);
    ctx.lineTo(canvas.width, 140);
    ctx.strokeStyle = "#ddd";
    ctx.stroke();

    drawPlayer();
    drawObstacles();
}

function animate() {
    if (isGameOver) return;
    update();
    draw();
    animationId = requestAnimationFrame(animate);
}

function gameOver() {
    isGameOver = true;
    
    // ç»˜åˆ¶åŠé€æ˜é®ç½©
    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // ç»˜åˆ¶æ–‡å­—
    ctx.fillStyle = '#333';
    ctx.font = "bold 30px Arial";
    ctx.textAlign = "center";
    ctx.fillText("è¢« DDL è¿½ä¸Šäº†ï¼ğŸ˜­", canvas.width / 2, canvas.height / 2 - 10);
    
    ctx.fillStyle = '#666';
    ctx.font = "16px Arial";
    ctx.fillText("å¾—åˆ†: " + score, canvas.width / 2, canvas.height / 2 + 25);
    
    restartBtn.style.display = 'inline-block';
    
    if (score > highScore) {
        highScore = score;
        localStorage.setItem('dinoHighScore', highScore);
        highScoreEl.innerText = highScore;
    }
}

// è·³è·ƒæ§åˆ¶
function jump() {
    if (player.grounded) {
        player.dy = player.jumpPower;
        player.grounded = false;
    }
}

// äº‹ä»¶ç›‘å¬
document.addEventListener('keydown', function(e) {
    if (e.code === 'Space' || e.code === 'ArrowUp') {
        e.preventDefault();
        if (isGameOver) initGame();
        else jump();
    }
});

canvas.addEventListener('touchstart', function(e) {
    e.preventDefault(); // é˜²æ­¢æ‰‹æœºæ»šåŠ¨
    if (isGameOver) initGame();
    else jump();
}, {passive: false});

canvas.addEventListener('mousedown', function(e) {
    if (isGameOver) initGame();
    else jump();
});

// å¯åŠ¨
initGame();
</script>
