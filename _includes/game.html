<!-- _includes/game.html -->
<section id="fun-zone" class="content-section" style="text-align: center; margin-top: 80px;">
  <h2 class="section-title" style="font-size: 1.5rem; color: #555;">ğŸƒ è¯¾é—´ä¼‘æ¯ (æŒ‰ç©ºæ ¼æˆ–ç‚¹å‡»è·³è·ƒ)</h2>
  <canvas id="dinoGame" width="600" height="150" style="border-bottom: 2px solid #333; background: #fafafa; max-width: 100%; touch-action: none;"></canvas>
  <p style="font-size: 0.8rem; color: #999; margin-top: 10px;">å½“å‰å¾—åˆ†: <span id="score">0</span> | æœ€é«˜åˆ†: <span id="highScore">0</span></p>
  <button id="restartBtn" class="button-primary" style="display: none; margin-top: 10px;" onclick="initGame()">å†ç©ä¸€æ¬¡</button>
</section>

<script>
const canvas = document.getElementById('dinoGame');
const ctx = canvas.getContext('2d');
const scoreEl = document.getElementById('score');
const highScoreEl = document.getElementById('highScore');
const restartBtn = document.getElementById('restartBtn');

let gameSpeed = 3;
let score = 0;
let highScore = localStorage.getItem('dinoHighScore') || 0;
let isGameOver = false;
let animationId;

// æ¸¸æˆå¯¹è±¡
let player = {
    x: 50,
    y: 100,
    w: 30, // å®½åº¦
    h: 30, // é«˜åº¦
    dy: 0, // å‚ç›´é€Ÿåº¦
    jumpPower: -12, // è·³è·ƒåŠ›åº¦
    gravity: 0.6, // é‡åŠ›
    grounded: false
};

let obstacles = [];
let frame = 0;

// åˆå§‹åŒ–/é‡ç½®æ¸¸æˆ
function initGame() {
    isGameOver = false;
    score = 0;
    gameSpeed = 5;
    obstacles = [];
    frame = 0;
    player.y = 100;
    player.dy = 0;
    restartBtn.style.display = 'none';
    scoreEl.innerText = score;
    highScoreEl.innerText = highScore;
    animate();
}

// ç»˜åˆ¶ç©å®¶ (å¯ä»¥ç”¨ä½ çš„å¤´åƒä»£æ›¿fillRect)
function drawPlayer() {
    ctx.fillStyle = '#007bff'; // è“è‰²æ–¹å—ä»£è¡¨ä½ 
    ctx.fillRect(player.x, player.y, player.w, player.h);
    
    // å¦‚æœæƒ³ç”¨å›¾ç‰‡ï¼Œæ³¨é‡Šæ‰ä¸Šé¢ä¸¤è¡Œï¼Œè§£å¼€ä¸‹é¢ï¼š
    // let img = new Image(); img.src = '/assets/img/bio.png';
    // ctx.drawImage(img, player.x, player.y, player.w, player.h);
}

// ç»˜åˆ¶éšœç¢ç‰©
function drawObstacles() {
    ctx.fillStyle = '#c0392b'; // çº¢è‰²éšœç¢ç‰©
    obstacles.forEach(obs => {
        ctx.fillRect(obs.x, obs.y, obs.w, obs.h);
    });
}

// æ ¸å¿ƒç‰©ç†é€»è¾‘
function update() {
    // 1. ç©å®¶è·³è·ƒç‰©ç†
    player.dy += player.gravity;
    player.y += player.dy;

    // åœ°é¢ç¢°æ’æ£€æµ‹
    if (player.y + player.h > canvas.height) {
        player.y = canvas.height - player.h;
        player.dy = 0;
        player.grounded = true;
    } else {
        player.grounded = false;
    }

    // 2. ç”Ÿæˆéšœç¢ç‰© (éšæœºé—´éš”)
    frame++;
    if (frame % Math.floor(100 + Math.random() * 50) === 0) {
        // éšæœºé«˜åº¦å’Œå®½åº¦çš„éšœç¢ç‰©
        let h = Math.floor(Math.random() * 30) + 20; 
        obstacles.push({
            x: canvas.width,
            y: canvas.height - h,
            w: 20,
            h: h
        });
    }

    // 3. ç§»åŠ¨éšœç¢ç‰© & ç¢°æ’æ£€æµ‹
    for (let i = 0; i < obstacles.length; i++) {
        let obs = obstacles[i];
        obs.x -= gameSpeed;

        // ç§»é™¤å±å¹•å¤–çš„éšœç¢ç‰©
        if (obs.x + obs.w < 0) {
            obstacles.splice(i, 1);
            score++;
            scoreEl.innerText = score;
            i--;
            
            // â­ï¸ æ ¸å¿ƒç©æ³•ï¼šéšç€å¾—åˆ†å¢åŠ ï¼Œé€Ÿåº¦è¶Šæ¥è¶Šå¿«
            if (score % 5 === 0) gameSpeed += 0.5; 
        }

        // ç®€å•çš„çŸ©å½¢ç¢°æ’æ£€æµ‹
        if (
            player.x < obs.x + obs.w &&
            player.x + player.w > obs.x &&
            player.y < obs.y + obs.h &&
            player.y + player.h > obs.y
        ) {
            gameOver();
        }
    }
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawPlayer();
    drawObstacles();
}

function animate() {
    if (isGameOver) return;
    update();
    draw();
    animationId = requestAnimationFrame(animate);
}

function gameOver() {
    isGameOver = true;
    ctx.fillStyle = 'rgba(0,0,0,0.5)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = 'white';
    ctx.font = '20px Arial';
    ctx.fillText("Game Over!", canvas.width / 2 - 50, canvas.height / 2);
    
    restartBtn.style.display = 'inline-block';
    
    if (score > highScore) {
        highScore = score;
        localStorage.setItem('dinoHighScore', highScore);
        highScoreEl.innerText = highScore;
    }
}

// è·³è·ƒåŠ¨ä½œ
function jump() {
    if (player.grounded) {
        player.dy = player.jumpPower;
        player.grounded = false;
    }
}

// ç›‘å¬é”®ç›˜ç©ºæ ¼å’Œç‚¹å‡»/è§¦æ‘¸äº‹ä»¶
document.addEventListener('keydown', function(e) {
    if (e.code === 'Space') {
        e.preventDefault(); // é˜²æ­¢ç½‘é¡µæ»šåŠ¨
        if (isGameOver) initGame();
        else jump();
    }
});

canvas.addEventListener('touchstart', function(e) {
    e.preventDefault();
    if (isGameOver) initGame();
    else jump();
});

canvas.addEventListener('mousedown', function(e) {
    if (isGameOver) initGame();
    else jump();
});

// å¯åŠ¨æ¸¸æˆ
initGame();
</script>
